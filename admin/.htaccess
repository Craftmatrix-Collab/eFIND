# eFIND Admin Panel - Production .htaccess Configuration
# Enhanced security with session-based URL rewriting

# Enable RewriteEngine
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /admin/

    # Additional Security Headers for Admin Panel
    Header always set X-Frame-Options "DENY"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' cdn.jsdelivr.net cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' cdn.jsdelivr.net cdnjs.cloudflare.com fonts.googleapis.com; font-src 'self' cdn.jsdelivr.net cdnjs.cloudflare.com fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https://minio-gckgwk48ccskg4ogswwgk88s.craftmatrix.org"
    
    # Prevent directory listing
    Options -Indexes
    
    # Set default index file to login.php
    DirectoryIndex login.php
    
    # Block direct access to sensitive directories
    RewriteRule ^includes/ - [F,L]
    RewriteRule ^uploads/ - [F,L]
    
    # Protect sensitive files
    <FilesMatch "(config|minio_config|auth|logger|\.env|\.git|\.sql|\.bak)">
        Require all denied
    </FilesMatch>
    
    # Allow direct .php access (no URL rewriting to clean URLs)
    # This ensures /admin/login.php and /admin/login both work without redirect loops
    
    # Block access to test files in production
    <FilesMatch "^(test_|debug_|phpinfo)">
        Require all denied
    </FilesMatch>
    
    # Protect against SQL injection in URLs
    RewriteCond %{QUERY_STRING} ([0-9]+)=([0-9]+) [OR]
    RewriteCond %{QUERY_STRING} (union.*select|select.*from|insert.*into|delete.*from|drop.*table) [NC]
    RewriteRule .* - [F,L]
    
    # Block access to version control files
    RedirectMatch 404 /\.git
    RedirectMatch 404 /\.svn
    
    # Custom error pages - Use simple static HTML to avoid redirect loops
    ErrorDocument 404 /404.html
    ErrorDocument 403 /admin/error/403.php
    ErrorDocument 500 /admin/error/500.php
</IfModule>

# PHP Security Settings for Admin
<IfModule mod_php7.c>
    php_flag display_errors Off
    php_flag display_startup_errors Off
    php_flag log_errors On
    php_flag expose_php Off
    php_value session.cookie_httponly 1
    php_value session.cookie_secure 1
    php_value session.use_strict_mode 1
    php_value session.cookie_samesite Strict
    php_value session.gc_maxlifetime 3600
    php_value session.name EFIND_ADMIN_SESSION
</IfModule>

# Disable script execution in uploads directory
<IfModule mod_php7.c>
    <Directory "uploads">
        php_flag engine off
    </Directory>
</IfModule>

# File upload limits for admin panel
<IfModule mod_php7.c>
    php_value upload_max_filesize 10M
    php_value post_max_size 12M
    php_value max_execution_time 300
    php_value max_input_time 300
    php_value memory_limit 256M
</IfModule>

# Compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json application/xml
</IfModule>

# Browser Caching
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType text/html "access plus 0 seconds"
</IfModule>

# Limit request methods
<LimitExcept GET POST>
    Require all denied
</LimitExcept>

# Force POST method for sensitive endpoints
<FilesMatch "^(login|register|update_|add_|delete_|process_|api).*\.php$">
    <LimitExcept POST>
        Require all denied
    </LimitExcept>
</FilesMatch>

# Rate limiting (requires mod_evasive or similar)
# <IfModule mod_evasive24.c>
#     DOSHashTableSize 3097
#     DOSPageCount 5
#     DOSSiteCount 50
#     DOSPageInterval 1
#     DOSSiteInterval 1
#     DOSBlockingPeriod 10
# </IfModule>

# Block suspicious user agents
<IfModule mod_rewrite.c>
    RewriteCond %{HTTP_USER_AGENT} (nikto|sqlmap|fimap|nessus|openvas|metasploit|havij|acunetix) [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} (morpheus|zmeu|attacks|libwww-perl|winhttp|clshttp|loader) [NC]
    RewriteRule .* - [F,L]
</IfModule>

# Prevent access to backup files
<FilesMatch "\.(bak|backup|old|orig|save|swp|tmp)$">
    Require all denied
</FilesMatch>
