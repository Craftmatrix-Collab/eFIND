services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: efind-app-test
    restart: unless-stopped
    env_file:
      - .env
    depends_on:
      db:
        condition: service_healthy
      minio:
        condition: service_started
      minio-init:
        condition: service_completed_successfully
    environment:
      DB_HOST: db
      DB_PORT: 3306
      DB_USER: ${DB_USER:-root}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_NAME: ${DB_NAME:-barangay_poblacion_south}
      DB_DATABASE: ${DB_NAME:-barangay_poblacion_south}
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
      MINIO_BUCKET: efind-documents
      MINIO_REGION: us-east-1
      MINIO_USE_SSL: false
      MINIO_PORT: 9000
      MINIO_CONSOLE_URL: http://minio:9001
      MINIO_API_URL: http://minio:9000
      RESEND_API_KEY: ${RESEND_API_KEY:-}
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
    ports:
      - "7070:80"
    volumes:
      - ./admin/includes/minio_config.test.php:/var/www/html/admin/includes/minio_config.php:ro
    networks:
      - app_net
      - internal_net

  db:
    image: mariadb:10.11
    container_name: efind-db-test
    restart: unless-stopped
    env_file:
      - .env
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME:-barangay_poblacion_south}
      TZ: Asia/Manila
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    volumes:
      - db_data_test:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mariadb-admin ping -h 127.0.0.1 -uroot -p$$MYSQL_ROOT_PASSWORD --silent"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 20s
    networks:
      - internal_net

  minio:
    image: minio/minio:latest
    container_name: efind-minio-test
    restart: unless-stopped
    env_file:
      - .env
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    volumes:
      - minio_data_test:/data
    networks:
      - internal_net

  minio-init:
    image: minio/mc:latest
    container_name: efind-minio-init-test
    restart: "no"
    env_file:
      - .env
    depends_on:
      - minio
    entrypoint: /bin/sh
    command: >
      -c "
      until mc alias set local http://minio:9000 ${MINIO_ROOT_USER} ${MINIO_ROOT_PASSWORD}; do
        sleep 2;
      done;
      mc mb -p local/efind-documents || true;
      mc anonymous set download local/efind-documents || true;
      "
    networks:
      - internal_net

volumes:
  db_data_test:
  minio_data_test:

networks:
  app_net:
    driver: bridge
  internal_net:
    driver: bridge
    internal: true
