# eFIND System - Production .htaccess Configuration
# Hide filenames, improve security, and enable clean URLs

# Enable RewriteEngine
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /

    # Security Headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Prevent directory listing
    Options -Indexes
    
    # Block access to sensitive files
    <FilesMatch "(^#.*#|\.(bak|conf|dist|fla|inc|ini|log|psd|sh|sql|sw[op])|~)$">
        Require all denied
    </FilesMatch>
    
    # Protect configuration files
    <FilesMatch "^(config|minio_config|\.env|composer\.(json|lock)|package(-lock)?\.json)">
        Require all denied
    </FilesMatch>
    
    # Protect includes directory
    RewriteRule ^includes/ - [F,L]
    
    # Allow both .php and clean URLs without redirect loops
    # Only rewrite if the file doesn't exist but a .php version does
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_FILENAME}\.php -f
    RewriteRule ^([^\.]+)$ $1.php [NC,L]
    
    # Force HTTPS in production (uncomment when ready)
    # RewriteCond %{HTTPS} off
    # RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
    
    # Custom error pages - Use simple static HTML to avoid redirect loops
    ErrorDocument 404 /404.html
</IfModule>

# PHP Security Settings
<IfModule mod_php7.c>
    php_flag display_errors Off
    php_flag display_startup_errors Off
    php_flag log_errors On
    php_flag expose_php Off
    php_value session.cookie_httponly 1
    php_value session.cookie_secure 1
    php_value session.use_strict_mode 1
</IfModule>

# Compression for better performance
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
</IfModule>

# Browser Caching
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType application/pdf "access plus 1 month"
    ExpiresByType text/html "access plus 0 seconds"
</IfModule>

# Limit file upload size (adjust as needed)
<IfModule mod_php7.c>
    php_value upload_max_filesize 10M
    php_value post_max_size 12M
    php_value max_execution_time 300
    php_value max_input_time 300
</IfModule>

# Protect against clickjacking
<IfModule mod_headers.c>
    Header always append X-Frame-Options SAMEORIGIN
</IfModule>

# Block bad bots and scanners
<IfModule mod_rewrite.c>
    RewriteCond %{HTTP_USER_AGENT} (nikto|sqlmap|fimap|nessus|openvas|metasploit) [NC]
    RewriteRule .* - [F,L]
</IfModule>
